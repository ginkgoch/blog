<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="keywords" content="ginkgoch, gis, mapping">
    <title>
        Mapping for Fun - Ginkgoch Blog
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://ginkgoch.com/favicon-v2.png">
    
    <link rel="stylesheet" href="/css/style.css">

    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="http://osly086qe.bkt.clouddn.com/hexo-infinite-scroll-v1.0.1.min.css">
    <script src="http://osly086qe.bkt.clouddn.com/hexo-infinite-scroll-v1.0.3.min.js"></script>
    <script>
        infiniteScroll()

        // for mobile menu
        $(function() {
            $('.social-button').click(function() {
                if ($('.social-links').hasClass('hide-links')) {
                    $('.social-links').removeClass('hide-links')
                } else {
                    $('.social-links').addClass('hide-links')
                }
            })
        })
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-124252185-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-124252185-1');
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4307304935160022",
        enable_page_level_ads: true
    });
    </script>
</head>

    <body>
        <div class="container">
            <header class="header">
    <h1 class="title">
        <center><img src="/img/logo.png" style="max-width: 120px;" /></center>
        <a href="/" class="logo">
            Ginkgoch
        </a>
    </h1>
    <h2 class="desc">
        Made cross-platform GIS mapping easy
    </h2>

    <nav class="links">
        <button class="social-button">
            menu
        </button>
        <ul class="social-links hide-links">
            
                <li>
                    <a href="https://ginkgoch.com">
                        Home
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/ginkgoch">
                        Github
                    </a>
                </li>
                
                <li>
                    <a href="https://twitter.com/ginkgoch1">
                        Twitter
                    </a>
                </li>
                
                <li>
                    <a href="https://www.facebook.com/yun.ginkgoch.1">
                        Facebook
                    </a>
                </li>
                
        </ul>
    </nav>
</header>
                <main class="main">
                    <article class="post">
    
            <h2 class="post-title">
                一张新型肺炎地区分布地图是怎么制作的？
            </h2>
            <ul class="post-date">
                <li>
                    2020-02-01
                </li>
                <li>
                    Ginkgoch
                </li>
            </ul>
            <div class="post-content">
                <p>2020年刚开始，各钟不幸的消息满天飞。新型肺炎的蔓延，科比去世… 无时无刻让我感到痛楚。为了不给国家添乱，新年几天都在窝在家里。时不时拿起手机，观察一下现在病情蔓延情况。下面这张地图就是一张典型的GIS应用。</p>
<a id="more"></a> 

<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#让我们从环境开始">让我们从环境开始</a></li>
<li><a href="#创建工程添加引用">创建工程，添加引用</a></li>
<li><a href="#gis数据">GIS数据</a></li>
<li><a href="#剩下的工作就很简单了">剩下的工作就很简单了</a><ul>
<li><a href="#叠加世界数据">叠加世界数据</a></li>
<li><a href="#叠加中国数据">叠加中国数据</a></li>
<li><a href="#调整可视范围">调整可视范围</a></li>
<li><a href="#连接动态数据">连接动态数据</a></li>
<li><a href="#样式化地图">样式化地图</a></li>
</ul>
</li>
<li><a href="#写在最后">写在最后</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="/post-imgs/20200201/infection-cover-status-demo.png" alt="infection-cover-status-demo"></p>
<p>每当我看到这张静态图时，很想要知道几个信息无法获知。</p>
<ol>
<li>我们能通过颜色和图例比较一个省的确诊人数范围，看不到一个省具体患病人数。</li>
<li>由于是一张静态图，我们没法获市级数据。如果地图可以拖动，放大缩小就简单多了。</li>
<li>每次看到红色，心里都很焦虑。能换成其他颜色，我自己更加能接受点。</li>
</ol>
<p>基于这两个小功能，我准备介绍一下怎么去制作一张地图。我准备分两个阶段来做介绍。</p>
<ol>
<li>先用最简洁的代码来生成一张静态图片。通过这个阶段，让我们认识一下<code>Ginkgoch</code>地图开发的<code>API</code>.</li>
<li>当我们了解了<code>Ginkgoch</code>地图开发的<code>API</code>之后，我们就把这个程序改造成地图服务，让她和知名的地图前端库<code>Leaflet</code>合并开发一个可交互的地图，集成点有趣的功能。</li>
</ol>
<p>这篇文章，我准备先从制作一张静态图片开始。</p>
<blockquote>
<p><a href="https://ginkgoch.com" target="_blank" rel="noopener"><code>Ginkgoch</code>地图开发套件</a>是一个GIS全栈开发套件。用一种语言 - <code>JavaScript</code> 就可以开发地图相关的命令行程序，地图桌面程序，以及地图服务。</p>
</blockquote>
<h2 id="让我们从环境开始"><a href="#让我们从环境开始" class="headerlink" title="让我们从环境开始"></a>让我们从环境开始</h2><p><strong>以前开发地图应用软件</strong>，可能需要掌握很多编程语言技能，才能胜任一个完整的项目。比如一个典型的GIS B/S应用一般会使用Java, C#或其他后端编程语言来开发后端，然后用JavaScript + HTML来开发前端展现。</p>
<p>今天我们使用<code>Ginkgoch</code>开发，就不再需要了解其他编程语言，用我们熟悉的JavaScript；即使是前端开发人员也可以开发后端地图应用了。追求极简开发环境的话，我们只需要2个工具。<a href="https://nodejs.org" target="_blank" rel="noopener">Node.js</a> （推荐8以上，或者直接安装最新版本都是兼容的）和 <a href="https://code.visualstudio.com/" target="_blank" rel="noopener">vscode</a>.</p>
<blockquote>
<p>这篇文章照顾新手，写的比较多。老鸟请自行过滤。勿喷。</p>
</blockquote>
<h2 id="创建工程，添加引用"><a href="#创建工程，添加引用" class="headerlink" title="创建工程，添加引用"></a>创建工程，添加引用</h2><p>接着，我们创建一个工程目录。用以下命令就可以了。（我个人比较喜欢使用命令行，由于平时都是用macOS做日常使用机器。所以以下命令行都是macOS执行验证的）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建项目目录</span></span><br><span class="line"><span class="built_in">cd</span> [your workspace]</span><br><span class="line">md nCoV-map</span><br><span class="line"><span class="built_in">cd</span> nCoV-map</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建项目，添加引用</span></span><br><span class="line">npm init -y</span><br><span class="line">npm i --save ginkgoch-map canvas lodash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个文件，这个将是我们写代码的地方</span></span><br><span class="line">touch tutorial-01.js</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里引用了另一个<code>canvas</code>库，是因为<code>Node.js</code>没有提供绘图API，我们只能引用一个第三方<code>Node.js</code>库来替代使用。</p>
</blockquote>
<p>到这里，我们的工程已经建立好了。</p>
<h2 id="GIS数据"><a href="#GIS数据" class="headerlink" title="GIS数据"></a>GIS数据</h2><p>GIS应用里面数据是很重要的。我把她分为静态数据和动态数据。静态数据就是我们的几何图形以及她们特定的特征数据。如地区的名字等。动态数据就是我们实时关注的疫情变化。</p>
<p>一般<strong>静态数据</strong>比较容易找到。百度搜索中国地图数据csv, json, shapefile都可以找到。这个项目里面，我准备使用shapefile作为我的静态数据。<a href="https://github.com/ginkgoch/nCoV-map/tree/develop/data" target="_blank" rel="noopener">这里</a>你可以找到以下数据，我们一会儿会使用到。把上面数据下载下来以后，放到工程的<code>data</code>目录下面。</p>
<ul>
<li>chn/<ul>
<li>gadm36_CHN_1_3857.shp - 省级数据</li>
<li>gadm36_CHN_2_3857.shp - 市级数据</li>
</ul>
</li>
<li>cntry02.shp - 世界国家数据</li>
</ul>
<p><strong>动态数据</strong>会麻烦点。我是写了一个爬虫，定时爬取。有兴趣可以私聊。不过作为例子，我放上了几份疫情数据在<code>data/infected</code>目录里面以便做示例。</p>
<h2 id="剩下的工作就很简单了"><a href="#剩下的工作就很简单了" class="headerlink" title="剩下的工作就很简单了"></a>剩下的工作就很简单了</h2><h3 id="叠加世界数据"><a href="#叠加世界数据" class="headerlink" title="叠加世界数据"></a>叠加世界数据</h3><p>首先，我们定义一个函数来创建一个地图的图层，一个数据源即一个数据图层，多个数据图层叠加起来就可以构成我们期望的样式。使用<code>ginkgoch-map</code>，我们是这样定义一个图层的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createLayerWithDefaultStyle</span>(<span class="params">filePath</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// create a source with the specified shapefile file path</span></span><br><span class="line">    <span class="keyword">let</span> source = <span class="keyword">new</span> GK.ShapefileFeatureSource(path.resolve(__dirname, filePath));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrap the source as a world layer</span></span><br><span class="line">    <span class="keyword">let</span> layer = <span class="keyword">new</span> GK.FeatureLayer(source);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set a style on the layer</span></span><br><span class="line">    layer.styles.push(<span class="keyword">new</span> GK.FillStyle(<span class="string">'#f0f0f0'</span>, <span class="string">'#636363'</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> layer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了<code>layer</code>, 我们可以简单查看我们数据图层的样子。比如对于数据<code>cntry02.shp</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let worldLayer = createLayerWithDefaultStyle(&apos;../data/cntry02.shp&apos;);</span><br><span class="line">await worldLayer.open();</span><br><span class="line">let worldImage = await worldLayer.thumbnail(512, 512);</span><br><span class="line">fs.writeFileSync(path.resolve(__dirname, &apos;./images/tutorial-01-world.png&apos;), worldImage.toBuffer());</span><br></pre></td></tr></table></figure>

<p>我们通过命令行执行下面的语句。我们可以找到图片：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node tutorial-01.js</span><br></pre></td></tr></table></figure>

<p><img src="/post-imgs/20200201/tutorial-01-world.png" alt="tutorial-01-world.png"></p>
<h3 id="叠加中国数据"><a href="#叠加中国数据" class="headerlink" title="叠加中国数据"></a>叠加中国数据</h3><p>当然这个不是我们想要的样子，我们还需要把省份的数据叠加在上面，才能看到我们中国详细一点的数据。我们接着做。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [imageWidth, imageHeight] = [<span class="number">512</span>, <span class="number">512</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a world layer with cntry02.shp</span></span><br><span class="line"><span class="keyword">let</span> worldLayer = createLayerWithDefaultStyle(<span class="string">'../data/cntry02.shp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a province layer with gadm36_CHN_1_3857.shp</span></span><br><span class="line"><span class="keyword">let</span> provinceLayer = createLayerWithDefaultStyle(<span class="string">'../data/chn/gadm36_CHN_1_3857.shp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mapEngine = <span class="keyword">new</span> GK.MapEngine(imageWidth, imageHeight);</span><br><span class="line">mapEngine.srs = <span class="keyword">new</span> GK.Srs(<span class="string">'EPSG:900913'</span>);</span><br><span class="line">mapEngine.pushLayer(worldLayer);</span><br><span class="line">mapEngine.pushLayer(provinceLayer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> image = <span class="keyword">await</span> mapEngine.image();</span><br><span class="line">fs.writeFileSync(path.resolve(__dirname, <span class="string">'./images/tutorial-01-default.png'</span>), image.toBuffer());</span><br></pre></td></tr></table></figure>

<p>现在再打开图片<code>tutorial-01-default.png</code>, 注意查看中国的数据已经叠加成功了。</p>
<p><img src="/post-imgs/20200201/tutorial-01-default.png" alt="tutorial-01-default.png"></p>
<h3 id="调整可视范围"><a href="#调整可视范围" class="headerlink" title="调整可视范围"></a>调整可视范围</h3><p>哦？太小了~ 好，我们调整下地图的可视范围。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> provinceLayer.open();</span><br><span class="line"><span class="keyword">let</span> chinaEnvelope = <span class="keyword">await</span> provinceLayer.envelope();</span><br><span class="line">chinaEnvelope = GK.ViewportUtils.adjustEnvelopeToMatchScreenSize(chinaEnvelope, imageWidth, imageHeight);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> image = <span class="keyword">await</span> mapEngine.image(chinaEnvelope);</span><br><span class="line">fs.writeFileSync(path.resolve(__dirname, <span class="string">'./images/tutorial-01-china.png'</span>), image.toBuffer());</span><br></pre></td></tr></table></figure>

<p><img src="/post-imgs/20200201/tutorial-01-china.png" alt="tutorial-01-china.png"></p>
<h3 id="连接动态数据"><a href="#连接动态数据" class="headerlink" title="连接动态数据"></a>连接动态数据</h3><p>我们对静态数据进行了渲染，同时对中国省份级别的边框进行绘制。接下来，我们将连接动态数据，把动态的感染人数和地图对应起来。我们怎么做呢？</p>
<p>首先，我们先看下静态数据的特征数据。Shapefile的特征数据存放在*.dbf文件里面。你可以选择使用你常用的工具打开dbf文件。我个人一般使用的是<code>shapefile viewer</code>来查看。参考<a href="https://github.com/ginkgoch/node-shapefile-viewer" target="_blank" rel="noopener">这里获取程序及使用说明</a>。</p>
<p><img src="/post-imgs/20200201/china-attributes.png" alt="china-attributes.png"></p>
<p><code>NL_NAME_1</code>就是我们需要的省份名字，然后我们来看看动态数据的一个片段。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"provinceName"</span>: <span class="string">"湖北省"</span>,</span><br><span class="line">        <span class="attr">"provinceShortName"</span>: <span class="string">"湖北"</span>,</span><br><span class="line">        <span class="attr">"confirmedCount"</span>: <span class="number">4586</span>,</span><br><span class="line">        <span class="attr">"suspectedCount"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"curedCount"</span>: <span class="number">90</span>,</span><br><span class="line">        <span class="attr">"deadCount"</span>: <span class="number">162</span>,</span><br><span class="line">        <span class="attr">"comment"</span>: <span class="string">"待明确地区：治愈 30"</span>,</span><br><span class="line">        <span class="attr">"cities"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"cityName"</span>: <span class="string">"武汉"</span>,</span><br><span class="line">                <span class="attr">"confirmedCount"</span>: <span class="number">2261</span>,</span><br><span class="line">                <span class="attr">"suspectedCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"curedCount"</span>: <span class="number">54</span>,</span><br><span class="line">                <span class="attr">"deadCount"</span>: <span class="number">129</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"cityName"</span>: <span class="string">"黄冈"</span>,</span><br><span class="line">                <span class="attr">"confirmedCount"</span>: <span class="number">496</span>,</span><br><span class="line">                <span class="attr">"suspectedCount"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"curedCount"</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">"deadCount"</span>: <span class="number">12</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<p>有趣的是，动态数据也包含省份的名字<code>provinceShortName</code>；以及感染，疑似，治愈以及死亡的人数。现在，我们要做的就是通过静态数据的<code>NL_NAME_1</code>和动态数据的<code>provinceShortName</code>相等的数据相关联。在<code>ginkgoch-map</code>里面是这样做的。</p>
<p>首先，我们定义一个函数来帮助我们定义一个关系。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * field - the dynamic field value to return.</span></span><br><span class="line"><span class="comment"> * infectedData - the infected data in JSON format.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getDynamicFieldForProvince</span>(<span class="params">field, infectedData</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        name: field, <span class="attr">fieldsDependOn</span>: [<span class="string">'NL_NAME_1'</span>], <span class="attr">mapper</span>: <span class="function"><span class="params">feature</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> fullName = feature.properties.get(<span class="string">'NL_NAME_1'</span>);</span><br><span class="line">            <span class="keyword">const</span> infectionInfo = _.find(infectedData, d =&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> fullName.includes(d.provinceShortName);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (infectionInfo === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> infectionInfo[field];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后建立4个列的映射函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectDynamicData</span>(<span class="params">layer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// load dynamic data</span></span><br><span class="line">    <span class="keyword">let</span> dynamicData = fs.readFileSync(path.resolve(__dirname, <span class="string">'../data/infected/1580376765333.json'</span>)).toString();</span><br><span class="line">    dynamicData = <span class="built_in">JSON</span>.parse(dynamicData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// connect 4 dynamic attribute fields to the source.</span></span><br><span class="line">    <span class="keyword">const</span> source = layer.source;</span><br><span class="line">    source.dynamicFields.push(_getDynamicFieldForProvince(<span class="string">'confirmedCount'</span>, dynamicData));</span><br><span class="line">    source.dynamicFields.push(_getDynamicFieldForProvince(<span class="string">'suspectedCount'</span>, dynamicData));</span><br><span class="line">    source.dynamicFields.push(_getDynamicFieldForProvince(<span class="string">'curedCount'</span>, dynamicData));</span><br><span class="line">    source.dynamicFields.push(_getDynamicFieldForProvince(<span class="string">'deadCount'</span>, dynamicData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们调用这个函数进行映射。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...省略前后重复的代码</span></span><br><span class="line"><span class="keyword">let</span> provinceLayer = createLayerWithDefaultStyle(<span class="string">'../data/chn/gadm36_CHN_1_3857.shp'</span>);</span><br><span class="line">connectDynamicData(provinceLayer);</span><br></pre></td></tr></table></figure>

<p>至此，我们可以认为<code>provinceLayer</code>已经包含了动态数据。她将在需要的时候动态的去通过映射关系找到需要的数据来使用。</p>
<h3 id="样式化地图"><a href="#样式化地图" class="headerlink" title="样式化地图"></a>样式化地图</h3><p>做到这里，大家可以去休息一下。迎接最后一步：地图样式化。我们把感染人数分成几个等级，根据等级渲染不同的颜色来表示严重程度。比较好的是，<code>ginkgoch-map</code>提供了对应的API来渲染。</p>
<p>我们先定义个函数来创建样式化对象<code>Style</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_getClassBreakStyle</span>(<span class="params">field</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> strokeColor = <span class="string">'#636363'</span>;</span><br><span class="line">    <span class="keyword">const</span> strokeWidth = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> countStops = [<span class="number">1</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">750</span>, <span class="number">1000</span>, <span class="built_in">Number</span>.MAX_SAFE_INTEGER];</span><br><span class="line">    <span class="keyword">let</span> activePallette = [<span class="string">'#fff5f0'</span>, <span class="string">'#fee0d2'</span>, <span class="string">'#fcbba1'</span>, <span class="string">'#fc9272'</span>, <span class="string">'#fb6a4a'</span>, <span class="string">'#ef3b2c'</span>, <span class="string">'#cb181d'</span>, <span class="string">'#67000d'</span>]</span><br><span class="line">    <span class="keyword">let</span> style = <span class="keyword">new</span> GK.ClassBreakStyle(field);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; countStops.length; i++) &#123;</span><br><span class="line">        style.classBreaks.push(&#123; <span class="attr">minimum</span>: countStops[i - <span class="number">1</span>], <span class="attr">maximum</span>: countStops[i], <span class="attr">style</span>: <span class="keyword">new</span> GK.FillStyle(activePallette[i - <span class="number">1</span>], strokeColor, strokeWidth) &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> style;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再应用到<code>layer</code>上即可看到效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> confirmedCountStyle = _getClassBreakStyle(<span class="string">'confirmedCount'</span>);</span><br><span class="line">provinceLayer.styles.push(confirmedCountStyle);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 顺便我们把文字渲染上去，即可完成。</span></span><br><span class="line"><span class="keyword">let</span> provinceLabelStyle = <span class="keyword">new</span> GK.TextStyle(<span class="string">'[NL_NAME_1]'</span>, <span class="string">'black'</span>, <span class="string">'Arial 12px'</span>);</span><br><span class="line">provinceLabelStyle.lineWidth = <span class="number">2</span>;</span><br><span class="line">provinceLabelStyle.strokeStyle = <span class="string">'white'</span>;</span><br><span class="line">provinceLabelStyle.location = <span class="string">'interior'</span>;</span><br><span class="line">provinceLayer.styles.push(provinceLabelStyle);</span><br></pre></td></tr></table></figure>

<p><img src="/post-imgs/20200201/tutorial-01-china-confirmed.png" alt="tutorial-01-china-confirmed.png"></p>
<p>是不是很有趣？我们现在可以随意替换调色板，让她变成蓝色系的。替换这一句即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// let activePallette = ['#fff5f0', '#fee0d2', '#fcbba1', '#fc9272', '#fb6a4a', '#ef3b2c', '#cb181d', '#67000d'];</span></span><br><span class="line"><span class="keyword">let</span> activePallette = [<span class="string">'#f7fbff'</span>, <span class="string">'#deebf7'</span>, <span class="string">'#c6dbef'</span>, <span class="string">'#9ecae1'</span>, <span class="string">'#6baed6'</span>, <span class="string">'#4292c6'</span>, <span class="string">'#2171b5'</span>, <span class="string">'#08519c'</span>];</span><br></pre></td></tr></table></figure>

<p><img src="/post-imgs/20200201/tutorial-01-final.png" alt="tutorial-01-final.png"></p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>最终的代码可以在这里下载：<a href="https://github.com/ginkgoch/nCoV-map/tree/develop/tutorials" target="_blank" rel="noopener">https://github.com/ginkgoch/nCoV-map/tree/develop/tutorials</a></p>
<p>看起来很多，大多数代码都是业务代码，和对样式的设置。了解起来还是挺简单的。今天就到这里，后面有时间，我再写一篇搭建一个地图服务，制作一个可以交互的地图应用。有问题可以随时联系我,<a href="mailto:ginkgoch@outlook.com" target="_blank" rel="noopener">ginkgoch@outlook.com</a>。或者到我的网站<a href="https://ginkgoch.com" target="_blank" rel="noopener">ginkgoch.com</a>上去留言。</p>
<p>Happy Mapping!</p>

            </div>
</article>

                </main>
                <aside class="aside">
                    <section class="aside-section">
                        
    <h1>Categories</h1>

    

                    </section>
                    <section class="aside-section">
                        
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a></li></ul>


                    </section>
                    <section class="aside-section tag">
                        
    <h1>Tags</h1>

    <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/array/">array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ginkgoch/">ginkgoch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gis/">gis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gis-tools/">gis tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/">map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map-builder/">map builder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map-server/">map server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nCoV-map/">nCoV map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nCov-map-of-China/">nCov map of China</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-io/">node-io</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service/">service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shapefile/">shapefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/slice/">slice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tiling/">tiling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xyz-service/">xyz service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zoom-level/">zoom level</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/新型肺炎地区分布地图/">新型肺炎地区分布地图</a></li></ul>

                    </section>
                </aside>
        </div>
    </body>

</html>